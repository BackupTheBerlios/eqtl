<?php
$conv=array();
$conv[1] = array(
/* D1Rat167 */	"0" => 4404878,
/* D1Rat10 */	"33.0626" => 25271050,
/* D1Rat257 */	"59.6914" => 54516880,
/* D1Rat265 */	"78.5345" => 90449000,
/* D1Rat36 */	"104.874" => 128874535,
/* D1Rat131 */	"114.263" => 145648743,
/* D1Rat49 */	"119.419" => 157497945,
/* D1Rat56 */	"127.678" => 172926307,
/* D1Rat66 */	"132.416" => 183946847,
/* D1Rat70 */	"147.621" => 205041048,
/* D1Rat188 */	"154.974" => 206567644,
/* D1Rat301 */	"189.253" => 234595191,
/* D1Rat86 */	"202.64" => 259173327,
/* D1Rat126 */	"207.498" => 262779963,
/* D1Rat235 */	"248.1" => 248100601
);
$conv[10] = array(
/* D10Rat96 */	"0" => 6172611,
/* D10Rat43 */	"22.6322" => 23428128,
/* D10Rat37 */	"35.1" => 35131432,
/* D10Rat78 */	"43.0871" => 43361251,
/* D10Rat81 */	"49.6" => 49618847,
/* D10Rat29 */	"61.413" => 68842891,
/* D10Rat219 */	"75.0213" => 81986621,
/* D10Rat18 */	"90.339" => 91208778,
/* D10Rat7 */	"111.837" => 105886242
);
$conv[11] = array(
/* D11Rat87 */	"0" => 1270722,
/* D11Rat76 */	"17.9566" => 27445617,
/* D11Rat68 */	"38.504" => 46793415,
/* D11Rat46 */	"64.838" => 81091342
);
$conv[12] = array(
/* D12Rat57 */	"0" => 3438583,
/* D12Mit2 */	"22.1012" => 20932560,
/* D12Rat23 */	"27.3156" => 25367107,
/* D12Mgh5 */	"29.1" => 29130181,
/* D12Rat20 */	"71.7127" => 44254904
);
$conv[13] = array(
/* D13Rat88 */	"0" => 42627611,
/* D13Rat42 */	"30.1037" => 74560243,
/* D13Rat54 */	"51.5722" => 9.45e+07 /* substituting non-existing Ensembl data with manual setting */,
/* D13Rat49 */	"59.2759" => 104400153
);
$conv[14] = array(
/* D14Rat1 */	"0" => 4895895,
/* D14Rat72 */	"2.35071" => 7697708,
/* D14Rat78 */	"10.1528" => 17564856,
/* D14Rat99 */	"21.6084" => 2.64e+07 /* substituting non-existing Ensembl data with manual setting */,
/* D14Rat14 */	"33.4" => 33448038,
/* D14Rat62 */	"52.8614" => 68771632,
/* D14Rat49 */	"82.3438" => 9.82e+07 /* substituting non-existing Ensembl data with manual setting */,
/* D14Rat110 */	"90.5594" => 107119264
);
$conv[15] = array(
/* D15Rat73 */	"0" => 766501,
/* D15Rat80 */	"25.5" => 25506389,
/* D15Rat123 */	"63.0094" => 58412002,
/* D15Rat99 */	"85.077" => 81981179,
/* D15Rat28 */	"110.034" => 107378191
);
$conv[16] = array(
/* D16Rat12 */	"0" => 350122,
/* D16Rat19 */	"26.4375" => 35339930,
/* D16Mgh5 */	"50.2" => 50266029,
/* D16Rat53 */	"51.7903" => 66606253,
/* D16Rat13 */	"83.2969" => 77968643,
/* D16Rat89 */	"84.0747" => 89009136
);
$conv[17] = array(
/* D17Rat6 */	"0" => 16053310,
/* D17Rat117 */	"25.9841" => 31007409,
/* D17Rat98 */	"48.3653" => 64047700,
/* D17Rat51 */	"84.828" => 96587775,
/* D17Rat47 */	"85.1001" => 8.50724e+07 /* substituting non-existing Ensembl data with manual setting */
);
$conv[18] = array(
/* D18Rat108 */	"0" => 11593055,
/* D18Rat116 */	"16.0006" => 40600399,
/* D18Rat74 */	"69.278" => 7.12e+07 /* substituting non-existing Ensembl data with manual setting */,
/* D18Rat76 */	"70.5592" => 79643542
);
$conv[19] = array(
/* D19Rat19 */	"0" => 7813538,
/* D19Rat10 */	"36.4485" => 40109361,
/* D19Rat8 */	"47.7195" => 4.36e+07 /* substituting non-existing Ensembl data with manual setting */,
/* D19Mit11 */	"54.3603" => 49565031
);
$conv[2] = array(
/* D2Rat3 */	"0" => 8678734,
/* D2Rat17 */	"34.4586" => 48244850,
/* D2Rat174 */	"47.0821" => 60124624,
/* D2Rat177 */	"64.0351" => 108159563,
/* D2Rat256 */	"78.2211" => 145455614,
/* D2Rat44 */	"95.4989" => 181710215,
/* D2Rat185 */	"163.667" => 238139979,
/* D2Mgh16 */	"175.409" => 2.505e+08 /* substituting non-existing Ensembl data with manual setting */,
/* D2Mgh12 */	"210.6" => 210636009
);
$conv[20] = array(
/* D20Rat31 */	"0" => 10410005,
/* D20Rat7 */	"22.184" => 26064462,
/* D20Rat16 */	"47.5229" => 46690376
);
$conv[3] = array(
/* D3Rat58 */	"0" => 10829519,
/* D3Rat44 */	"31.8953" => 41420306,
/* D3Rat81 */	"68.7441" => 9.52e+07 /* substituting non-existing Ensembl data with manual setting */,
/* D3Rat126 */	"79.1218" => 120891188,
/* D3Rat139 */	"135.988" => 161202737,
/* D3Rat147 */	"143.5" => 143492509
);
$conv[4] = array(
/* D4Mgh22 */	"0" => 4410369,
/* D4Rat222 */	"8.852" => 19044128,
/* D4Mgh14 */	"20.8858" => 36592629,
/* D4Rat25 */	"39.9092" => 65822169,
/* D4Rat177 */	"59.3719" => 114073977,
/* D4Rat196 */	"85.8815" => 143753496,
/* D4Got131 */	"102.213" => 162283990,
/* D4Got130 */	"107.008" => 166051146,
/* D4Mgh11 */	"109.814" => 171204378,
/* D4Rat84 */	"118.176" => 185398416,
/* D4Rat80 */	"132.3" => 132262560,
/* D4Mgh30 */	"154.9" => 154937061
);
$conv[5] = array(
/* D5Rat208 */	"0" => 7966797,
/* D5Rat73 */	"9.11139" => 25602275,
/* D5Rat6 */	"52.5" => 52530708,
/* D5Rat77 */	"66.6881" => 8.06e+07 /* substituting non-existing Ensembl data with manual setting */,
/* D5Rat83 */	"94.5619" => 125563751,
/* D5Rat171 */	"110.656" => 147509595,
/* D5Rat40 */	"124.075" => 1.567e+08 /* substituting non-existing Ensembl data with manual setting */,
/* D5Rat178 */	"132.574" => 1.61449e+08 /* substituting non-existing Ensembl data with manual setting */,
/* D5Rat50 */	"139.239" => 1.65e+08 /* substituting non-existing Ensembl data with manual setting */
);
$conv[6] = array(
/* D6Rat40 */	"0" => 1301953,
/* D6Rat47 */	"8.7901" => 14627484,
/* D6Rat31 */	"47.3906" => 4.34e+07 /* substituting non-existing Ensembl data with manual setting */,
/* D6Rat24 */	"63.8" => 63795021,
/* D6Rat100 */	"99.8353" => 100709526,
/* D6Mgh9 */	"123.3" => 123341445,
/* D6Rat79 */	"142.387" => 131029752
);
$conv[7] = array(
/* D7Rat154 */	"0" => 21224426,
/* D7Rat151 */	"30.1" => 30146703,
/* D7Rat103 */	"35.9024" => 44462830,
/* D7Mgh7 */	"53.7378" => 74244787,
/* D7Rat18 */	"75.8163" => 103612740,
/* D7Rat139 */	"89.9001" => 89944922,
/* D7Rat4 */	"107.671" => 134614034
);
$conv[8] = array(
/* D8Rat56 */	"0" => 8294861,
/* D8Rat163 */	"25.5693" => 31508525,
/* D8Rat41 */	"43.3313" => 50354909,
/* D8Rat104 */	"67.3312" => 8.44e+07 /* substituting non-existing Ensembl data with manual setting */,
/* D8Rat62 */	"70" => 70009520,
/* D8Mgh3 */	"91.181" => 103684650,
/* D8Rat2 */	"151.023" => 123415272
);
$conv[9] = array(
/* D9Rat135 */	"0" => 7e+06 /* substituting non-existing Ensembl data with manual setting */,
/* D9Rat130 */	"19.7245" => 20102047,
/* D9Rat76 */	"34.6017" => 33496795,
/* D9Rat63 */	"39.7" => 39691558,
/* D9Rat24 */	"46.2" => 46242655,
/* D9Rat16 */	"58.5" => 58516720,
/* D9Rat19 */	"59.5" => 59463565,
/* D9Rat5 */	"105.599" => 85186878,
/* D9Rat71 */	"121.831" => 106234734
);
$conv["X"] = array(
/* DXRat47 */	"0" => 26298304,
/* DXRat57 */	"24.1252" => 83729959,
/* DXRat130 */	"49.4121" => 1.585e+08 /* substituting non-existing Ensembl data with manual setting */
);

if (!empty($conv["X"])) $conv[21]=$conv["X"];
if (!empty($conv["Y"])) $conv[21 + 1]=$conv["Y"];


function cM2bp($chr,$cm=0) {
	global $conv;
	$chrconv=$conv[$chr];
	$cMmin=$bpmin=-1;
	$cMmax=$bpmax=-1;
	$actbp=$lastbp=-1;
	$actcM=$lastcM=-1;
	$found=FALSE;
	$prevcM=$secondCM=-1;
	$prevbp=$secondBP=-1;
	if (empty($chrconv)) {
		echo "<p>marker.php: No information for chromosome '$chr'.</p>\n";
		return (-2);
	} elseif (!is_array($chrconv)) {
		echo "<p>func_conversion_55.php: Internal error. (chr '$chr').</p>\n";
		return (-3);
	} else {
		foreach($chrconv as $cMorgan=>$bp) {
			if (-1 == $cMmin) {
				$cMmin=$cMmax=$cMorgan;
				$bpmin=$bpmax=$bp;
			}
			else {
				if (-1 == $secondCM && !empty($cMorgan)) {
					$secondCM=$cMorgan;
					$secondBP=$bp;
				}
				if ($bp>$bpmax) {
					$bpmax=$bp;
					$cMmax=$cMorgan;
				}
			}

			if ($found) {
			}
			else {
				if ($cm<$cMorgan) {
					$found=TRUE;
					if (-1 == $actcM) {
						$actcM=$cMorgan;
						$actbp=$bp;
						$lastcM=$prevcM;
						$lastbp=$prevbp;
					}
					break;
					break;
				}
			}
			$prevcM=$cMorgan;
			$prevbp=$bp;
		}

		if ($cm<=$cMmin) {
			// cM requested upstream of first marker
			$ret=$bpmin+($cm-$cMmin)/($secondCM-$cMmin)*($secondBP-$bpmin);
		} elseif (-1 != $actcM) {
			$ret=$lastbp+($cm-$lastcM)/($actcM-$lastcM)*($actbp-$lastbp);
		} else {
			// downstream of rightmost marker
			if ($cMmax==$cMmin) {
				// we only haev a single marker - helpless?
				// FIMXE: implement extra point (0,0)
				echo "<p>cMmax==cMmin ($cMmax==$cMmin)\n<p>";
				$ret=-1;
			}
			else {
				// extrapolating from the first to the last marker
				$ret=$bpmin+($cm-$cMmin)/($cMmax-$cMmin)*($bpmax-$bpmin);
			}
		}
		return(round($ret));
	}
}

function bp2cM($chr,$bpInput=0) {
	global $conv;
	$chrconv=$conv[$chr];
	$cMmin=$bpmin=-1;
	$cMmax=$bpmax=-1;
	$actbp=$lastbp=-1;
	$actcM=$lastcM=-1;
	$found=FALSE;
	$prevcM=$secondCM=-1;
	$prevbp=$secondBP=-1;
	if (empty($chrconv)) {
		echo "<p>marker.php: No information for chromosome '$chr'.</p>\n";
		return (-2);
	} elseif (!is_array($chrconv)) {
		echo "<p>func_conversion_55.php: Internal error. (chr '$chr').</p>\n";
		return (-3);
	} else {
		foreach($chrconv as $cMorgan=>$bp) {
			if (-1 == $cMmin) {
				# first time this loop was entered
				# this will also be the minimal value
				$cMmin=$cMmax=$cMorgan;
				$bpmin=$bpmax=$bp;
			}
			else {
				if (-1 == $secondCM && !empty($cMorgan)) {
					$secondCM=$cMorgan;
					$secondBP=$bp;
				}
				if ($bp>$bpmax) {
					$bpmax=$bp;
					$cMmax=$cMorgan;
				}
				if (! $bp >= $bpmin) { // avoiding the lt sign
					echo  "Suddenly found bp value at $bp smaller than current minimum at $bpmin.";
					$bpmin=$bp;
					$cMmin=$cMorgan;
				}
			}

			if ($found) {
			}
			else {
				if ($bpInput >= $bp) { // avoiding the lt sign for web presentation
				}
				else {
					$found=TRUE;
					if (-1 == $actcM) {
						$actcM=$cMorgan;
						$actbp=$bp;
						$lastcM=$prevcM;
						$lastbp=$prevbp;
					}
					break;
				}
			}
			$prevcM=$cMorgan;
			$prevbp=$bp;
		}

		if ($bpInput<=$bpmin) {
			// bp requested upstream of first marker
			$ret=$cMmin+($bpInput-$bpmin)/($secondBP-$bpmin)*($secondCM-$cMmin);
		} elseif (-1 != $actcM) {
			$ret=$lastcM+($bpInput-$lastbp)/($actbp-$lastbp)*($actcM-$lastcM);
		} else {
			// downstream of rightmost marker
			if ($cMmax==$cMmin) {
				// we only have a single marker - helpless?
				// FIMXE: implement extra point (0,0)
				echo "<p>cMmax==cMmin ($cMmax==$cMmin)\n<p>";
				$ret=-1;
			}
			else {
				// extrapolating from the first to the last marker
				$ret=$cMmin+($bpInput-$bpmin)/($bpmax-$bpmin)*($cMmax-$cMmin);
			}
		}
		return($ret);
	}
}
// This conversion is based on ensembl database ensembl_mart_58 on host martdb.ensembl.org:5316
?>
